<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Achievements Management - Admin</title>
  <link rel="stylesheet" href="css/style.css" />
  <link rel="stylesheet" href="css/components.css" />
  <link rel="stylesheet" href="css/admin.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
</head>
<body class="admin-dashboard">
  <!-- Loading Overlay -->
  <div id="loadingOverlay" class="loading-overlay" style="display:none;">
    <div class="loading-content">
      <div class="loading-spinner"></div>
      <p>Processing...</p>
    </div>
  </div>

  <!-- Header -->
  <header class="admin-header">
    <div class="admin-nav">
      <div class="admin-brand">
        <button id="mobileSidebarToggle" class="mobile-menu-toggle"><i class="fas fa-bars"></i></button>
        <h1><i class="fas fa-trophy"></i> Achievements Management</h1>
      </div>
      <div class="admin-user-menu">
        <div class="admin-actions">
          <a class="btn btn-outline" href="admin.html" title="Dashboard"><i class="fas fa-tachometer-alt"></i><span class="btn-text">Dashboard</span></a>
          <a class="btn btn-outline" href="content-management.html" title="Content"><i class="fas fa-layer-group"></i><span class="btn-text">Content Hub</span></a>
          <a class="btn btn-outline" href="communication.html" title="Communication"><i class="fas fa-envelope"></i><span class="btn-text">Communication</span></a>
          <a class="btn btn-outline" href="index.html" title="View Portfolio"><i class="fas fa-eye"></i><span class="btn-text">View Portfolio</span></a>
          <button class="btn btn-danger" onclick="adminDashboard.logout()" title="Logout"><i class="fas fa-sign-out-alt"></i><span class="btn-text">Logout</span></button>
        </div>
      </div>
    </div>
  </header>

  <div class="admin-layout">
    <!-- Sidebar -->
    <aside id="adminSidebar" class="admin-sidebar">
      <nav class="admin-nav-menu">
        <div class="nav-section">
          <div class="nav-section-title">Dashboard</div>
          <a href="admin.html#dashboard" class="nav-item">
            <i class="fas fa-chart-pie"></i>
            <span>Overview</span>
          </a>
        </div>

        <div class="nav-section">
          <div class="nav-section-title">Content Management</div>
          <a href="profile.html" class="nav-item">
            <i class="fas fa-user"></i>
            <span>Profile</span>
          </a>
          <a href="about.html" class="nav-item">
            <i class="fas fa-info-circle"></i>
            <span>About</span>
          </a>
          <a href="projects.html" class="nav-item">
            <i class="fas fa-project-diagram"></i>
            <span>Projects</span>
          </a>
          <a href="education.html" class="nav-item">
            <i class="fas fa-graduation-cap"></i>
            <span>Education</span>
          </a>
          <a href="achievements.html" class="nav-item active">
            <i class="fas fa-trophy"></i>
            <span>Achievements</span>
          </a>
        </div>

        <div class="nav-section">
          <div class="nav-section-title">Other</div>
          <a href="communication.html" class="nav-item">
            <i class="fas fa-envelope"></i>
            <span>Communication</span>
          </a>
          <a href="admin.html#settings" class="nav-item">
            <i class="fas fa-cogs"></i>
            <span>Settings</span>
          </a>
        </div>
      </nav>
    </aside>

    <!-- Main -->
    <main class="admin-main">
      <!-- Achievements Section -->
      <section id="achievements" class="admin-section active">
        <div class="section-header">
          <h2><i class="fas fa-trophy"></i> Achievements Management</h2>
          <p>Showcase your awards, certifications, and accomplishments</p>
        </div>

        <div class="content-grid">
          <!-- Add Achievement Form -->
          <div class="form-container">
            <h3 id="form-title"><i class="fas fa-plus"></i> Add Achievement</h3>
            <form id="achievement-form" class="admin-form">
              <div class="form-grid">
                <div class="form-group span-2">
                  <label for="achievement-title"><i class="fas fa-trophy"></i> Achievement Title *</label>
                  <input id="achievement-title" name="title" type="text" placeholder="e.g., AWS Certified Solutions Architect" required />
                </div>
                <div class="form-group span-2">
                  <label for="achievement-organization"><i class="fas fa-building"></i> Organization *</label>
                  <input id="achievement-organization" name="organization" type="text" placeholder="e.g., Amazon Web Services" required />
                </div>
                <div class="form-group">
                  <label for="achievement-date"><i class="fas fa-calendar"></i> Date Achieved *</label>
                  <input id="achievement-date" name="date" type="date" required />
                </div>
                <div class="form-group">
                  <label for="achievement-expiry"><i class="fas fa-calendar-times"></i> Expiry Date</label>
                  <input id="achievement-expiry" name="expiryDate" type="date" />
                </div>
                <div class="form-group">
                  <label for="achievement-type"><i class="fas fa-tags"></i> Type</label>
                  <select id="achievement-type" name="type">
                    <option value="Certification">Certification</option>
                    <option value="Award">Award</option>
                    <option value="Recognition">Recognition</option>
                    <option value="Competition">Competition</option>
                    <option value="Publication">Publication</option>
                    <option value="Patent">Patent</option>
                    <option value="License">License</option>
                    <option value="Course">Course Completion</option>
                    <option value="Other">Other</option>
                  </select>
                </div>
                <div class="form-group">
                  <label for="achievement-level"><i class="fas fa-medal"></i> Level</label>
                  <select id="achievement-level" name="level">
                    <option value="Expert">Expert</option>
                    <option value="Professional" selected>Professional</option>
                    <option value="Advanced">Advanced</option>
                    <option value="Intermediate">Intermediate</option>
                    <option value="Basic">Basic</option>
                  </select>
                </div>
                <div class="form-group">
                  <label for="achievement-score"><i class="fas fa-percentage"></i> Score/Grade</label>
                  <input id="achievement-score" name="score" type="text" placeholder="e.g., 95%, A+, Pass" />
                </div>
                <div class="form-group">
                  <label for="achievement-credential"><i class="fas fa-id-card"></i> Credential ID</label>
                  <input id="achievement-credential" name="credentialId" type="text" placeholder="Unique identifier" />
                </div>
                <div class="form-group">
                  <label for="achievement-certificate"><i class="fas fa-certificate"></i> Certificate URL</label>
                  <input id="achievement-certificate" name="certificateUrl" type="url" placeholder="https://certificate.example.com" />
                </div>
                <div class="form-group">
                  <label for="achievement-verify"><i class="fas fa-check-circle"></i> Verification URL</label>
                  <input id="achievement-verify" name="verificationUrl" type="url" placeholder="https://verify.example.com" />
                </div>
                <div class="form-group span-2">
                  <label for="achievement-skills"><i class="fas fa-cogs"></i> Related Skills</label>
                  <input id="achievement-skills" name="skills" type="text" placeholder="List skills gained or demonstrated, separated by commas" />
                </div>
                <div class="form-group span-2">
                  <label for="achievement-description"><i class="fas fa-align-left"></i> Description</label>
                  <textarea id="achievement-description" name="description" rows="3" placeholder="Describe the achievement, skills gained, or impact..."></textarea>
                </div>
              </div>

              <div class="form-section">
                <h4><i class="fas fa-cogs"></i> Achievement Settings</h4>
                <div class="form-grid">
                  <div class="form-group">
                    <label class="checkbox-label">
                      <input type="checkbox" name="featured" id="achievement-featured">
                      <span class="checkmark"></span>
                      Featured achievement
                    </label>
                  </div>
                  <div class="form-group">
                    <label class="checkbox-label">
                      <input type="checkbox" name="showInPortfolio" id="achievement-show" checked>
                      <span class="checkmark"></span>
                      Show in portfolio
                    </label>
                  </div>
                  <div class="form-group">
                    <label class="checkbox-label">
                      <input type="checkbox" name="verified" id="achievement-verified">
                      <span class="checkmark"></span>
                      Verified achievement
                    </label>
                  </div>
                  <div class="form-group">
                    <label class="checkbox-label">
                      <input type="checkbox" name="lifetime" id="achievement-lifetime">
                      <span class="checkmark"></span>
                      Lifetime achievement
                    </label>
                  </div>
                </div>
              </div>

              <div class="form-actions">
                <button type="submit" class="btn btn-primary">
                  <i class="fas fa-plus"></i> <span id="submit-text">Add Achievement</span>
                </button>
                <button type="reset" class="btn btn-secondary">
                  <i class="fas fa-times"></i> Clear Form
                </button>
                <button type="button" class="btn btn-success" onclick="previewAchievements()">
                  <i class="fas fa-eye"></i> Preview
                </button>
                <button type="button" class="btn btn-info" onclick="importFromCredly()" style="display:none;">
                  <i class="fas fa-download"></i> Import from Credly
                </button>
              </div>
            </form>
          </div>

          <!-- Achievements List -->
          <div class="data-container">
            <div class="achievements-header">
              <h3><i class="fas fa-list"></i> Current Achievements</h3>
              <div class="achievements-filters">
                <select id="type-filter" onchange="filterAchievements()">
                  <option value="all">All Types</option>
                  <option value="Certification">Certifications</option>
                  <option value="Award">Awards</option>
                  <option value="Recognition">Recognition</option>
                  <option value="Competition">Competition</option>
                  <option value="Publication">Publications</option>
                  <option value="Other">Other</option>
                </select>
                <select id="level-filter" onchange="filterAchievements()">
                  <option value="all">All Levels</option>
                  <option value="Expert">Expert</option>
                  <option value="Professional">Professional</option>
                  <option value="Advanced">Advanced</option>
                  <option value="Intermediate">Intermediate</option>
                  <option value="Basic">Basic</option>
                </select>
                <button class="btn btn-sm btn-warning" onclick="checkExpiring()">
                  <i class="fas fa-clock"></i> Check Expiring
                </button>
                <button class="btn btn-sm btn-info" onclick="exportAchievements()">
                  <i class="fas fa-download"></i> Export
                </button>
              </div>
            </div>
            
            <div id="achievements-grid" class="achievements-grid">
              <!-- Achievements will be populated by JavaScript -->
            </div>

            <div class="achievements-stats">
              <div class="stats-summary">
                <div class="stat-item">
                  <i class="fas fa-trophy"></i>
                  <span>Total: <strong id="total-achievements">0</strong></span>
                </div>
                <div class="stat-item">
                  <i class="fas fa-certificate"></i>
                  <span>Certifications: <strong id="total-certifications">0</strong></span>
                </div>
                <div class="stat-item">
                  <i class="fas fa-award"></i>
                  <span>Awards: <strong id="total-awards">0</strong></span>
                </div>
                <div class="stat-item">
                  <i class="fas fa-clock"></i>
                  <span>Expiring Soon: <strong id="expiring-soon">0</strong></span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>
    </main>
  </div>

  <div id="toastContainer" class="toast-container"></div>

  <script src="js/mock-api.js"></script>
  <script src="js/admin-dashboard.js"></script>
  <script>
    let editingAchievementId = null;

    // Setup mobile sidebar toggle
    document.addEventListener('DOMContentLoaded', function() {
        const mobileSidebarToggle = document.getElementById('mobileSidebarToggle');
        const adminSidebar = document.getElementById('adminSidebar');
        
        if (mobileSidebarToggle && adminSidebar) {
            mobileSidebarToggle.addEventListener('click', function() {
                adminSidebar.classList.toggle('active');
                mobileSidebarToggle.classList.toggle('active');
                document.body.classList.toggle('sidebar-open');
            });
        }

        // Load and display achievements
        loadAchievements();
        updateAchievementsStats();

        // Handle lifetime checkbox
        const lifetimeCheckbox = document.getElementById('achievement-lifetime');
        const expiryInput = document.getElementById('achievement-expiry');
        
        if (lifetimeCheckbox && expiryInput) {
            lifetimeCheckbox.addEventListener('change', function() {
                expiryInput.disabled = this.checked;
                if (this.checked) {
                    expiryInput.value = '';
                }
            });
        }
    });

    // Preview achievements function
    function previewAchievements() {
        window.open('index.html#achievements', '_blank');
    }

    // Load achievements and populate grid
    function loadAchievements() {
        if (window.adminDashboard && window.adminDashboard.portfolioData) {
            const achievements = window.adminDashboard.portfolioData.achievements || [];
            populateAchievementsGrid(achievements);
        }
    }

    // Populate achievements grid
    function populateAchievementsGrid(achievements) {
        const grid = document.getElementById('achievements-grid');
        if (!grid) return;

        if (achievements.length === 0) {
            grid.innerHTML = '<div class="no-data"><i class="fas fa-trophy"></i><p>No achievements yet. Add your first achievement!</p></div>';
            return;
        }

        // Sort by date (most recent first)
        const sortedAchievements = achievements.sort((a, b) => {
            return new Date(b.date || '1900-01-01') - new Date(a.date || '1900-01-01');
        });

        grid.innerHTML = sortedAchievements.map(achievement => {
            const typeSafe = (achievement.type || 'Certification').toString();
            const typeClass = typeSafe.toLowerCase().replace(/\s+/g, '-');
            const levelSafe = (achievement.level || 'Professional').toString();
            const dateObj = achievement.date ? new Date(achievement.date) : null;
            const dateStr = (dateObj && !isNaN(dateObj)) ? dateObj.toLocaleDateString() : 'N/A';
            const orgSafe = achievement.organization || '—';
            const titleSafe = achievement.title || 'Untitled';
            const descSafe = achievement.description || '';
            
            // Check if expiring soon
            const expiryDate = achievement.expiryDate ? new Date(achievement.expiryDate) : null;
            const isExpiring = expiryDate && (expiryDate - new Date()) < (90 * 24 * 60 * 60 * 1000); // 90 days
            const isExpired = expiryDate && expiryDate < new Date();

            return `
            <div class="achievement-card" data-id="${achievement.id}" data-type="${typeSafe}" data-level="${levelSafe}" ${isExpiring ? 'data-expiring="true"' : ''}>
                <div class="achievement-header">
                    <h4><i class="fas fa-trophy"></i> ${titleSafe}</h4>
                    <div class="achievement-badges">
                        <span class="type-badge type-${typeClass}">${typeSafe}</span>
                        ${achievement.featured ? '<span class="featured-badge"><i class="fas fa-star"></i> Featured</span>' : ''}
                        ${achievement.verified ? '<span class="verified-badge"><i class="fas fa-check-circle"></i> Verified</span>' : ''}
                        ${isExpired ? '<span class="expired-badge"><i class="fas fa-times-circle"></i> Expired</span>' : 
                          isExpiring ? '<span class="expiring-badge"><i class="fas fa-exclamation-triangle"></i> Expiring</span>' : ''}
                    </div>
                </div>
                <p class="achievement-org"><strong><i class="fas fa-building"></i> ${orgSafe}</strong></p>
                <p class="achievement-description">${descSafe}</p>
                <div class="achievement-meta">
                    <span class="date-tag"><i class="fas fa-calendar"></i> ${dateStr}</span>
                    <span class="level-tag"><i class="fas fa-medal"></i> ${levelSafe}</span>
                    ${achievement.score ? `<span class="score-tag"><i class="fas fa-percentage"></i> ${achievement.score}</span>` : ''}
                </div>
                ${achievement.skills ? `<div class="skills-tags">${achievement.skills.split(',').map(skill => `<span class="skill-tag">${skill.trim()}</span>`).join('')}</div>` : ''}
                ${expiryDate && !achievement.lifetime ? `<div class="expiry-info"><i class="fas fa-clock"></i> Expires: ${expiryDate.toLocaleDateString()}</div>` : ''}
                <div class="card-actions">
                    <button class="btn btn-sm btn-secondary" onclick="editAchievement(${achievement.id})">
                        <i class="fas fa-edit"></i> Edit
                    </button>
                    <button class="btn btn-sm btn-danger" onclick="deleteAchievement(${achievement.id})">
                        <i class="fas fa-trash"></i> Delete
                    </button>
                    ${achievement.certificateUrl ? `<a href="${achievement.certificateUrl}" target="_blank" class="btn btn-sm btn-success">
                        <i class="fas fa-certificate"></i> View
                    </a>` : ''}
                    ${achievement.verificationUrl ? `<a href="${achievement.verificationUrl}" target="_blank" class="btn btn-sm btn-info">
                        <i class="fas fa-check"></i> Verify
                    </a>` : ''}
                </div>
            </div>
            `;
        }).join('');

        updateAchievementsStats();
    }

    // Edit achievement function
    function editAchievement(id) {
        if (!window.adminDashboard || !window.adminDashboard.portfolioData) return;
        
        const achievement = window.adminDashboard.portfolioData.achievements.find(a => a.id === id);
        if (!achievement) return;

        editingAchievementId = id;
        
        // Fill form with achievement data
        Object.keys(achievement).forEach(key => {
            const element = document.getElementById(`achievement-${key}`) || document.querySelector(`[name="${key}"]`);
            if (element) {
                if (element.type === 'checkbox') {
                    element.checked = !!achievement[key];
                } else if (element.type === 'date' && achievement[key]) {
                    element.value = new Date(achievement[key]).toISOString().slice(0, 10);
                } else {
                    element.value = achievement[key] || '';
                }
            }
        });

        // Update form UI
        document.getElementById('form-title').innerHTML = '<i class="fas fa-edit"></i> Edit Achievement';
        document.getElementById('submit-text').textContent = 'Update Achievement';

        // Scroll to form
        document.querySelector('.form-container').scrollIntoView({ behavior: 'smooth' });
    }

    // Delete achievement function
    function deleteAchievement(id) {
        if (!confirm('Are you sure you want to delete this achievement?')) return;
        
        if (window.adminDashboard && window.adminDashboard.deleteAchievementHandler) {
            window.adminDashboard.deleteAchievementHandler(id);
            loadAchievements();
        }
    }

    // Filter achievements
    function filterAchievements() {
        const typeFilter = document.getElementById('type-filter').value;
        const levelFilter = document.getElementById('level-filter').value;
        const cards = document.querySelectorAll('.achievement-card');

        cards.forEach(card => {
            const type = card.dataset.type;
            const level = card.dataset.level;
            
            const typeMatch = typeFilter === 'all' || type === typeFilter;
            const levelMatch = levelFilter === 'all' || level === levelFilter;
            
            card.style.display = typeMatch && levelMatch ? 'block' : 'none';
        });
    }

    // Check expiring achievements
    function checkExpiring() {
        const expiringCards = document.querySelectorAll('.achievement-card[data-expiring="true"]');
        if (expiringCards.length === 0) {
            if (window.adminDashboard && window.adminDashboard.showToast) {
                window.adminDashboard.showToast('No achievements expiring soon!', 'success');
            }
            return;
        }

        // Hide all cards first
        document.querySelectorAll('.achievement-card').forEach(card => {
            card.style.display = 'none';
        });

        // Show only expiring cards
        expiringCards.forEach(card => {
            card.style.display = 'block';
        });

        if (window.adminDashboard && window.adminDashboard.showToast) {
            window.adminDashboard.showToast(`Found ${expiringCards.length} achievements expiring soon`, 'warning');
        }
    }

    // Update achievements statistics
    function updateAchievementsStats() {
        const cards = document.querySelectorAll('.achievement-card');
        const total = cards.length;
        const certifications = document.querySelectorAll('.achievement-card[data-type="Certification"]').length;
        const awards = document.querySelectorAll('.achievement-card[data-type="Award"]').length;
        const expiring = document.querySelectorAll('.achievement-card[data-expiring="true"]').length;

        document.getElementById('total-achievements').textContent = total;
        document.getElementById('total-certifications').textContent = certifications;
        document.getElementById('total-awards').textContent = awards;
        document.getElementById('expiring-soon').textContent = expiring;
    }

    // Export achievements
    function exportAchievements() {
        if (!window.adminDashboard || !window.adminDashboard.portfolioData) return;
        
        const achievements = window.adminDashboard.portfolioData.achievements || [];
        const dataStr = JSON.stringify(achievements, null, 2);
        const dataBlob = new Blob([dataStr], {type: 'application/json'});
        
        const link = document.createElement('a');
        link.href = URL.createObjectURL(dataBlob);
        link.download = 'achievements-export.json';
        link.click();
    }

    // Import from Credly (placeholder)
    function importFromCredly() {
        if (window.adminDashboard && window.adminDashboard.showToast) {
            window.adminDashboard.showToast('Credly import feature coming soon!', 'info');
        }
    }

    // Handle form submission
    document.getElementById('achievement-form').addEventListener('submit', function(e) {
        e.preventDefault();
        
        if (window.adminDashboard && window.adminDashboard.handleAchievementSubmit) {
            // Set editing ID if in edit mode
            if (editingAchievementId) {
                this.dataset.editingId = editingAchievementId;
            }
            
            window.adminDashboard.handleAchievementSubmit(e);
            
            // Reset form state after submission
            setTimeout(() => {
                editingAchievementId = null;
                delete this.dataset.editingId;
                document.getElementById('form-title').innerHTML = '<i class="fas fa-plus"></i> Add Achievement';
                document.getElementById('submit-text').textContent = 'Add Achievement';
                loadAchievements();
            }, 1000);
        }
    });
  </script>
</body>
</html>